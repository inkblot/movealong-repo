#!/bin/bash
set -e

# Function to detect distribution codename
detect_codename() {
    # Try lsb_release first (most reliable)
    if command -v lsb_release >/dev/null 2>&1; then
        lsb_release -cs
        return 0
    fi

    # Fall back to /etc/os-release
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        echo "${VERSION_CODENAME:-stable}"
        return 0
    fi

    # Last resort: use stable
    echo "stable"
}

# Validate codename against supported list
validate_codename() {
    local codename="$1"
    case "$codename" in
        # Ubuntu releases
        jammy|noble|focal)
            return 0
            ;;
        # Debian releases
        bullseye|bookworm|trixie)
            return 0
            ;;
        # Fallback
        stable)
            return 0
            ;;
        *)
            echo "Warning: Unsupported distribution codename: $codename" >&2
            return 1
            ;;
    esac
}

# Only configure codename on fresh install, not upgrade
if [ "$1" = "configure" ] && [ -z "$2" ]; then
    CODENAME=$(detect_codename)

    if ! validate_codename "$CODENAME"; then
        CODENAME="stable"
    fi

    TARGET="/etc/apt/sources.list.d/movealong.list"
    sed -i "s/stable/$CODENAME/" "$TARGET"

    echo "Configured movealong repository for: $CODENAME"
fi

#DEBHELPER#
