#!/bin/bash
set -e

# Function to detect distribution codename
detect_codename() {
    # Try lsb_release first (most reliable)
    if command -v lsb_release >/dev/null 2>&1; then
        lsb_release -cs
        return 0
    fi

    # Fall back to /etc/os-release
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        echo "${VERSION_CODENAME:-stable}"
        return 0
    fi

    # Last resort: use stable
    echo "stable"
}

# Validate codename against supported list
validate_codename() {
    local codename="$1"
    case "$codename" in
        # Ubuntu releases
        jammy|noble|focal)
            return 0
            ;;
        # Debian releases
        bullseye|bookworm|trixie)
            return 0
            ;;
        # Fallback
        stable)
            return 0
            ;;
        *)
            echo "Warning: Unsupported distribution codename: $codename" >&2
            echo "Falling back to 'stable'" >&2
            echo "stable"
            return 1
            ;;
    esac
}

# Main installation logic
if [ "$1" = "configure" ]; then
    CODENAME=$(detect_codename)

    # Validate and potentially override with stable
    if ! validate_codename "$CODENAME" >/dev/null 2>&1; then
        CODENAME="stable"
    fi

    TEMPLATE="/etc/apt/sources.list.d/movealong.list.template"
    TARGET="/etc/apt/sources.list.d/movealong.list"

    # Generate sources list from template
    if [ -f "$TEMPLATE" ]; then
        sed "s/\${CODENAME}/$CODENAME/g" "$TEMPLATE" > "$TARGET"
        chmod 644 "$TARGET"

        # Clean up template
        rm -f "$TEMPLATE"

        echo "Configured movealong repository for: $CODENAME"
    else
        echo "Warning: Template file not found, using fallback" >&2
        echo "deb [signed-by=/usr/share/keyrings/inkblot-movealong-keyring.gpg] https://dist.movealong.org/apt stable main" > "$TARGET"
        chmod 644 "$TARGET"
    fi
fi


